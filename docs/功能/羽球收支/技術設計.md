# 羽球收支管理系統 技術設計

## 技術架構

```
┌─────────────────────────────────────────────────────┐
│                    瀏覽器                            │
│  ┌───────────────────────────────────────────────┐  │
│  │  index.html                                    │  │
│  │  ├── Tailwind CSS (CDN)                       │  │
│  │  ├── Firebase SDK (CDN)                       │  │
│  │  └── app.js (主程式)                          │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────┬───────────────────────────┘
                          │ HTTPS
                          ▼
┌─────────────────────────────────────────────────────┐
│                  Firebase                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │  Firestore  │  │    Auth     │  │   Hosting   │ │
│  │  (資料庫)   │  │ (Google登入)│  │  (靜態網站) │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
```

---

## 資料結構

### Collection: `accounting`

儲存所有收支記錄

```typescript
interface AccountingRecord {
  // 識別
  id: string;              // Firestore 自動生成

  // 基本資料
  date: string;            // 日期 (YYYY/MM/DD)
  location: string;        // 地點
  name: string;            // 姓名
  identity: string;        // 身分 (會員/非會員/-)
  item: string;            // 項目

  // 金額
  amountDue: number;       // 應收（正數=收入，負數=支出）
  amountPaid: number;      // 已收

  // 狀態
  status: string;          // 狀態 (已繳清/已支付/-)
  note: string;            // 備註

  // 系統欄位
  createdAt: Timestamp;    // 建立時間 (UTC)
  updatedAt: Timestamp;    // 更新時間 (UTC)
  createdBy: string;       // 建立者 email
}
```

**欄位驗證規則**：

| 欄位 | 必填 | 預設值 | 備註 |
|------|------|--------|------|
| date | 是 | - | 格式 YYYY/MM/DD |
| location | 否 | "" | |
| name | 是 | - | |
| identity | 否 | "-" | |
| item | 否 | "" | |
| amountDue | 是 | 0 | |
| amountPaid | 否 | 0 | |
| status | 否 | "-" | |
| note | 否 | "" | |

### Collection: `settings`

儲存系統設定

**Document: `allowedEmails`**

```typescript
interface AllowedEmails {
  emails: string[];  // 允許登入的 email 清單
}
```

範例：
```json
{
  "emails": [
    "admin@example.com",
    "manager@example.com"
  ]
}
```

---

## Firebase 設定

### firebase-config.js

```javascript
// Firebase 設定（需由用戶填入）
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// 初始化 Firebase
firebase.initializeApp(firebaseConfig);

// 服務參考
const db = firebase.firestore();
const auth = firebase.auth();
```

### Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 收支記錄
    match /accounting/{docId} {
      // 任何人可讀取
      allow read: if true;

      // 只有白名單使用者可寫入
      allow write: if isAllowedUser();
    }

    // 設定（只有白名單使用者可讀寫）
    match /settings/{docId} {
      allow read, write: if isAllowedUser();
    }

    // 輔助函數：檢查是否為允許的使用者
    function isAllowedUser() {
      return request.auth != null &&
             request.auth.token.email in
             get(/databases/$(database)/documents/settings/allowedEmails).data.emails;
    }
  }
}
```

### Firebase Auth 設定

1. 在 Firebase Console 啟用 Google 登入
2. 設定授權網域（localhost + 正式網域）

---

## 前端模組設計

### 檔案結構

```
badmintonSPA/
├── index.html              # 主要 HTML
├── firebase-config.js      # Firebase 設定
├── js/
│   ├── app.js             # 主程式進入點
│   ├── auth.js            # 登入登出邏輯
│   ├── firestore.js       # Firestore CRUD
│   ├── table.js           # 表格渲染
│   ├── stats.js           # 統計計算
│   ├── filter.js          # 篩選邏輯
│   ├── csv.js             # CSV 匯入匯出
│   ├── dialog.js          # Dialog 管理
│   └── toast.js           # 通知提示
├── firestore.rules         # Firestore 規則
└── docs/                   # 文件
```

### 模組職責

| 模組 | 職責 |
|------|------|
| `app.js` | 初始化、狀態管理、事件綁定 |
| `auth.js` | Google 登入/登出、權限檢查 |
| `firestore.js` | CRUD 操作封裝 |
| `table.js` | 表格 DOM 渲染 |
| `stats.js` | 統計數字計算 |
| `filter.js` | 日期、姓名篩選 |
| `csv.js` | CSV 解析與產生 |
| `dialog.js` | Modal 開關、表單處理 |
| `toast.js` | 成功/錯誤通知 |

---

## API 封裝

### firestore.js

```javascript
const Accounting = {
  // 取得所有記錄
  async getAll() {
    const snapshot = await db.collection('accounting')
      .orderBy('date', 'desc')
      .get();
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  },

  // 新增記錄
  async create(data) {
    const docRef = await db.collection('accounting').add({
      ...data,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: auth.currentUser?.email || 'unknown'
    });
    return docRef.id;
  },

  // 更新記錄
  async update(id, data) {
    await db.collection('accounting').doc(id).update({
      ...data,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  },

  // 刪除記錄
  async delete(id) {
    await db.collection('accounting').doc(id).delete();
  },

  // 批次新增（CSV 匯入用）
  async batchCreate(records) {
    const batch = db.batch();
    records.forEach(record => {
      const docRef = db.collection('accounting').doc();
      batch.set(docRef, {
        ...record,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: auth.currentUser?.email || 'unknown'
      });
    });
    await batch.commit();
  }
};
```

### auth.js

```javascript
const Auth = {
  // Google 登入
  async signIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await auth.signInWithPopup(provider);

    // 檢查白名單
    const allowed = await this.isAllowed(result.user.email);
    if (!allowed) {
      await auth.signOut();
      throw new Error('權限不足，請聯絡管理員');
    }
    return result.user;
  },

  // 登出
  async signOut() {
    await auth.signOut();
  },

  // 檢查是否在白名單
  async isAllowed(email) {
    const doc = await db.collection('settings').doc('allowedEmails').get();
    if (!doc.exists) return false;
    return doc.data().emails.includes(email);
  },

  // 監聽登入狀態
  onAuthStateChanged(callback) {
    return auth.onAuthStateChanged(callback);
  },

  // 取得目前使用者
  getCurrentUser() {
    return auth.currentUser;
  }
};
```

---

## CSV 格式

### 匯出格式

```csv
時間,地點,姓名,身分,項目,應收,已收,狀態,備註
2024/01/15,台中市,王小明,會員,場地費,300,300,已繳清,
2024/01/15,台中市,李大華,非會員,場地費,350,0,未繳,下次補繳
```

### 匯入解析邏輯

```javascript
function parseCSV(csvText) {
  const lines = csvText.trim().split('\n');
  const headers = lines[0].split(',');

  // 欄位對應
  const fieldMap = {
    '時間': 'date',
    '地點': 'location',
    '姓名': 'name',
    '身分': 'identity',
    '項目': 'item',
    '應收': 'amountDue',
    '已收': 'amountPaid',
    '狀態': 'status',
    '備註': 'note'
  };

  return lines.slice(1).map(line => {
    const values = line.split(',');
    const record = {};

    headers.forEach((header, i) => {
      const field = fieldMap[header.trim()];
      if (field) {
        let value = values[i]?.trim() || '';
        // 數字欄位轉換
        if (['amountDue', 'amountPaid'].includes(field)) {
          value = parseFloat(value) || 0;
        }
        record[field] = value;
      }
    });

    // 補齊預設值
    return {
      date: record.date || '',
      location: record.location || '',
      name: record.name || '',
      identity: record.identity || '-',
      item: record.item || '',
      amountDue: record.amountDue || 0,
      amountPaid: record.amountPaid || 0,
      status: record.status || '-',
      note: record.note || ''
    };
  });
}
```

---

## 統計計算

```javascript
function calculateStats(records) {
  let totalIncome = 0;   // 總收入（應收正數）
  let totalExpense = 0;  // 總支出（應收負數的絕對值）

  records.forEach(record => {
    const amount = record.amountDue || 0;
    if (amount >= 0) {
      totalIncome += amount;
    } else {
      totalExpense += Math.abs(amount);
    }
  });

  return {
    totalIncome,
    totalExpense,
    balance: totalIncome - totalExpense
  };
}
```

---

## 錯誤處理

### 錯誤類型

| 類型 | 處理方式 |
|------|----------|
| 網路錯誤 | 顯示 toast「網路連線失敗，請稍後再試」 |
| 權限不足 | 顯示 toast「權限不足，請聯絡管理員」 |
| 驗證失敗 | 表單欄位顯示紅框與錯誤訊息 |
| CSV 格式錯誤 | 顯示 toast「CSV 格式錯誤，請檢查檔案」 |

### 全域錯誤攔截

```javascript
window.addEventListener('unhandledrejection', event => {
  console.error('Unhandled rejection:', event.reason);
  Toast.error('發生錯誤，請稍後再試');
});
```

---

## 部署流程

### Firebase Hosting 部署

```bash
# 1. 安裝 Firebase CLI
npm install -g firebase-tools

# 2. 登入
firebase login

# 3. 初始化專案
firebase init
# 選擇 Firestore + Hosting

# 4. 部署
firebase deploy
```

### 部署前檢查清單

- [ ] `firebase-config.js` 已填入正確設定
- [ ] Firestore rules 已設定
- [ ] Firebase Auth 已啟用 Google 登入
- [ ] `settings/allowedEmails` 已設定管理員清單
- [ ] 測試登入流程正常
- [ ] 測試 CRUD 功能正常
